---
// WHY Lightbox.astro: Fullscreen photo viewer with elegant minimal design
// Smooth transitions, keyboard/touch navigation

interface Props {
	photos?: string[];
}
---

<!-- Lightbox overlay -->
<div
	id="lightbox"
	class="fixed inset-0 z-[100] hidden bg-black/98"
	aria-hidden="true"
>
	<!-- Close button -->
	<button
		id="lightbox-close"
		class="absolute top-6 right-6 z-10 p-3 text-white/60 hover:text-white transition-colors duration-300"
		aria-label="Закрыть"
	>
		<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
			<line x1="18" y1="6" x2="6" y2="18"></line>
			<line x1="6" y1="6" x2="18" y2="18"></line>
		</svg>
	</button>

	<!-- Previous button -->
	<button
		id="lightbox-prev"
		class="absolute left-6 top-1/2 -translate-y-1/2 z-10 p-4 text-white/40 hover:text-white transition-colors duration-300"
		aria-label="Предыдущее фото"
	>
		<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
			<polyline points="15 18 9 12 15 6"></polyline>
		</svg>
	</button>

	<!-- Next button -->
	<button
		id="lightbox-next"
		class="absolute right-6 top-1/2 -translate-y-1/2 z-10 p-4 text-white/40 hover:text-white transition-colors duration-300"
		aria-label="Следующее фото"
	>
		<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
			<polyline points="9 18 15 12 9 6"></polyline>
		</svg>
	</button>

	<!-- Image container -->
	<div class="flex items-center justify-center h-full p-16">
		<img
			id="lightbox-image"
			src=""
			alt=""
			class="max-h-full max-w-full object-contain transition-opacity duration-300"
		/>
	</div>

	<!-- Counter -->
	<div id="lightbox-counter" class="absolute bottom-6 left-1/2 -translate-x-1/2 text-white/40 text-sm tracking-wide"></div>
</div>

<script is:inline>
	const state = {
		isOpen: false,
		currentIndex: 0,
		photos: [],
	};

	const lightbox = document.getElementById('lightbox');
	const lightboxImage = document.getElementById('lightbox-image');
	const lightboxCounter = document.getElementById('lightbox-counter');
	const closeBtn = document.getElementById('lightbox-close');
	const prevBtn = document.getElementById('lightbox-prev');
	const nextBtn = document.getElementById('lightbox-next');

	if (lightbox && lightboxImage && lightboxCounter && closeBtn && prevBtn && nextBtn) {
		function showImage(index) {
			if (!state.photos.length) return;

			state.currentIndex = (index + state.photos.length) % state.photos.length;
			const photo = state.photos[state.currentIndex];

			lightboxImage.style.opacity = '0.3';
			lightboxImage.src = photo;
			lightboxImage.alt = `Фото ${state.currentIndex + 1} из ${state.photos.length}`;

			lightboxImage.onload = () => {
				lightboxImage.style.opacity = '1';
			};

			lightboxCounter.textContent = `${state.currentIndex + 1} / ${state.photos.length}`;
		}

		function openLightbox(index, photos) {
			state.photos = photos;
			state.currentIndex = index;
			state.isOpen = true;

			showImage(index);

			lightbox.classList.remove('hidden');
			lightbox.setAttribute('aria-hidden', 'false');
			document.body.style.overflow = 'hidden';

			// Animate in
			lightbox.style.opacity = '0';
			requestAnimationFrame(() => {
				lightbox.style.transition = 'opacity 0.3s ease';
				lightbox.style.opacity = '1';
			});
		}

		function closeLightbox() {
			state.isOpen = false;
			
			lightbox.style.opacity = '0';
			setTimeout(() => {
				lightbox.classList.add('hidden');
				lightbox.setAttribute('aria-hidden', 'true');
				document.body.style.overflow = '';
				lightbox.style.transition = '';
			}, 300);
		}

		function nextImage() {
			showImage(state.currentIndex + 1);
		}

		function prevImage() {
			showImage(state.currentIndex - 1);
		}

		// Event listeners
		closeBtn.addEventListener('click', closeLightbox);
		nextBtn.addEventListener('click', (e) => {
			e.stopPropagation();
			nextImage();
		});
		prevBtn.addEventListener('click', (e) => {
			e.stopPropagation();
			prevImage();
		});

		lightbox.addEventListener('click', (e) => {
			if (e.target === lightbox) {
				closeLightbox();
			}
		});

		// Keyboard navigation
		document.addEventListener('keydown', (e) => {
			if (!state.isOpen) return;

			switch (e.key) {
				case 'ArrowLeft':
					prevImage();
					break;
				case 'ArrowRight':
					nextImage();
					break;
				case 'Escape':
					closeLightbox();
					break;
			}
		});

		// Touch swipe
		let touchStartX = 0;
		let touchStartY = 0;
		let touchStartTime = 0;

		lightbox.addEventListener('touchstart', (e) => {
			const touch = e.touches[0];
			touchStartX = touch.clientX;
			touchStartY = touch.clientY;
			touchStartTime = Date.now();
		}, { passive: true });

		lightbox.addEventListener('touchend', (e) => {
			if (!state.isOpen) return;

			const touch = e.changedTouches[0];
			const deltaX = touch.clientX - touchStartX;
			const deltaY = touch.clientY - touchStartY;
			const deltaTime = Date.now() - touchStartTime;

			if (
				Math.abs(deltaX) > 50 &&
				Math.abs(deltaY) < Math.abs(deltaX) &&
				deltaTime < 300
			) {
				if (deltaX > 0) {
					prevImage();
				} else {
					nextImage();
				}
			}
		}, { passive: true });

		// Listen for open event
		window.addEventListener('open-lightbox', (e) => {
			openLightbox(e.detail.index, e.detail.photos);
		});
	}
</script>
