---
// WHY Navigation.astro: Minimal navigation with dropdown menu on mobile
// Categories appear as a list below header, not fullscreen overlay
import { stripBase, categoryUrl, homeUrl } from '../lib/urls';

const categories = Object.values(
  import.meta.glob('/src/content/categories/*.json', { eager: true })
).map((module: any) => module.default);

const currentPath = stripBase(Astro.url.pathname);
---

<nav class="py-6 px-6 md:px-12">
	<div class="max-w-7xl mx-auto">
		<!-- Header row with logo and menu button -->
		<div class="flex items-center justify-between">
			<!-- Logo / Site Name -->
			<a 
				href={homeUrl()} 
				class="text-lg font-light tracking-wider text-white hover:opacity-70 transition-opacity duration-300"
				style="font-family: var(--font-serif);"
			>
				Portfolio
			</a>

			<!-- Desktop Navigation -->
			<ul class="hidden md:flex items-center gap-8">
				<li>
					<a
						href={homeUrl()}
						class:list={[
							'text-sm tracking-wide transition-opacity duration-300',
							currentPath === '/' ? 'text-white' : 'text-white/60 hover:text-white'
						]}
					>
						Все
					</a>
				</li>
				{categories.map((category) => (
					<li>
						<a
							href={categoryUrl(category.id)}
							class:list={[
								'text-sm tracking-wide transition-opacity duration-300',
								currentPath === `/category/${category.id}` ? 'text-white' : 'text-white/60 hover:text-white'
							]}
						>
							{category.title}
						</a>
					</li>
				))}
			</ul>

			<!-- Mobile Menu Button (hamburger icon) -->
			<button
				id="nav-menu-button"
				class="md:hidden text-white p-2"
				aria-expanded="false"
				aria-controls="nav-menu"
				aria-label="Меню"
			>
				<svg
					id="nav-menu-icon"
					xmlns="http://www.w3.org/2000/svg"
					width="24"
					height="24"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="1.5"
					stroke-linecap="round"
					stroke-linejoin="round"
					class="transition-transform duration-300"
				>
					<!-- Hamburger lines that transform to X when open -->
					<line id="line1" x1="4" y1="6" x2="20" y2="6" class="origin-center transition-all duration-300"></line>
					<line id="line2" x1="4" y1="12" x2="20" y2="12" class="origin-center transition-all duration-300"></line>
					<line id="line3" x1="4" y1="18" x2="20" y2="18" class="origin-center transition-all duration-300"></line>
				</svg>
			</button>
		</div>

		<!-- Mobile Dropdown Menu (below header, not overlay) -->
		<div
			id="nav-menu"
			class="md:hidden overflow-hidden transition-all duration-300 ease-out"
			style="max-height: 0;"
		>
			<ul class="flex flex-col gap-1 pt-6 pb-2">
				<li>
					<a
						href={homeUrl()}
						class:list={[
							'block py-3 text-base tracking-wide transition-colors duration-200 border-b border-white/10',
							currentPath === '/' ? 'text-white' : 'text-white/60 hover:text-white'
						]}
					>
						Все работы
					</a>
				</li>
				{categories.map((category) => (
					<li>
						<a
							href={categoryUrl(category.id)}
							class:list={[
								'block py-3 text-base tracking-wide transition-colors duration-200 border-b border-white/10',
								currentPath === `/category/${category.id}` ? 'text-white' : 'text-white/60 hover:text-white'
							]}
						>
							{category.title}
						</a>
					</li>
				))}
			</ul>
		</div>
	</div>
</nav>

<script>
	const menuButton = document.getElementById('nav-menu-button') as HTMLButtonElement | null;
	const menu = document.getElementById('nav-menu') as HTMLDivElement | null;
	const line1El = document.getElementById('line1') as SVGLineElement | null;
	const line2El = document.getElementById('line2') as SVGLineElement | null;
	const line3El = document.getElementById('line3') as SVGLineElement | null;

	if (menuButton && menu && line1El && line2El && line3El) {
		const btn = menuButton;
		const menuEl = menu;
		const l1 = line1El;
		const l2 = line2El;
		const l3 = line3El;
		let isOpen = false;

		function setHamburger(): void {
			l1.setAttribute('x1', '4');
			l1.setAttribute('y1', '6');
			l1.setAttribute('x2', '20');
			l1.setAttribute('y2', '6');
			l2.style.opacity = '1';
			l3.setAttribute('x1', '4');
			l3.setAttribute('y1', '18');
			l3.setAttribute('x2', '20');
			l3.setAttribute('y2', '18');
		}

		function setX(): void {
			l1.setAttribute('x1', '6');
			l1.setAttribute('y1', '6');
			l1.setAttribute('x2', '18');
			l1.setAttribute('y2', '18');
			l2.style.opacity = '0';
			l3.setAttribute('x1', '6');
			l3.setAttribute('y1', '18');
			l3.setAttribute('x2', '18');
			l3.setAttribute('y2', '6');
		}

		function toggleMenu(): void {
			isOpen = !isOpen;
			
			if (isOpen) {
				menuEl.style.maxHeight = menuEl.scrollHeight + 'px';
				setX();
			} else {
				menuEl.style.maxHeight = '0';
				setHamburger();
			}
			
			btn.setAttribute('aria-expanded', isOpen.toString());
		}

		btn.addEventListener('click', toggleMenu);

		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && isOpen) {
				toggleMenu();
			}
		});

		window.addEventListener('resize', () => {
			if (window.innerWidth >= 768 && isOpen) {
				menuEl.style.maxHeight = '0';
				setHamburger();
				btn.setAttribute('aria-expanded', 'false');
				isOpen = false;
			}
		});
	}
</script>
