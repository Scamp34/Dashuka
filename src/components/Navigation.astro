---
// WHY Navigation.astro: Minimal navigation with dropdown menu on mobile
// Categories appear as a list below header, not fullscreen overlay
import { stripBase, categoryUrl, homeUrl } from '../lib/urls';

const categories = Object.values(
  import.meta.glob('/src/content/categories/*.json', { eager: true })
).map((module: any) => module.default);

const currentPath = stripBase(Astro.url.pathname);
---

<nav class="py-6 px-6 md:px-12">
	<div class="max-w-7xl mx-auto">
		<!-- Header row with logo and menu button -->
		<div class="flex items-center justify-between">
			<!-- Logo / Site Name -->
			<a 
				href={homeUrl()} 
				class="text-lg font-light tracking-wider text-white hover:opacity-70 transition-opacity duration-300"
				style="font-family: var(--font-serif);"
			>
				Portfolio
			</a>

			<!-- Desktop Navigation -->
			<ul class="hidden md:flex items-center gap-8">
				<li>
					<a
						href={homeUrl()}
						class:list={[
							'text-sm tracking-wide transition-opacity duration-300',
							currentPath === '/' ? 'text-white' : 'text-white/60 hover:text-white'
						]}
					>
						Все
					</a>
				</li>
				{categories.map((category) => (
					<li>
						<a
							href={categoryUrl(category.id)}
							class:list={[
								'text-sm tracking-wide transition-opacity duration-300',
								currentPath === `/category/${category.id}` ? 'text-white' : 'text-white/60 hover:text-white'
							]}
						>
							{category.title}
						</a>
					</li>
				))}
			</ul>

			<!-- Mobile Menu Button -->
			<button
				id="nav-menu-button"
				class="md:hidden text-white p-2 flex items-center gap-2"
				aria-expanded="false"
				aria-controls="nav-menu"
			>
				<span class="text-sm tracking-wide">Категории</span>
				<svg
					id="nav-menu-icon"
					xmlns="http://www.w3.org/2000/svg"
					width="16"
					height="16"
					viewBox="0 0 24 24"
					fill="none"
					stroke="currentColor"
					stroke-width="2"
					stroke-linecap="round"
					stroke-linejoin="round"
					class="transition-transform duration-300"
				>
					<polyline points="6 9 12 15 18 9"></polyline>
				</svg>
			</button>
		</div>

		<!-- Mobile Dropdown Menu (below header, not overlay) -->
		<div
			id="nav-menu"
			class="md:hidden overflow-hidden transition-all duration-300 ease-out"
			style="max-height: 0;"
		>
			<ul class="flex flex-col gap-1 pt-6 pb-2">
				<li>
					<a
						href={homeUrl()}
						class:list={[
							'block py-3 text-base tracking-wide transition-colors duration-200 border-b border-white/10',
							currentPath === '/' ? 'text-white' : 'text-white/60 hover:text-white'
						]}
					>
						Все работы
					</a>
				</li>
				{categories.map((category) => (
					<li>
						<a
							href={categoryUrl(category.id)}
							class:list={[
								'block py-3 text-base tracking-wide transition-colors duration-200 border-b border-white/10',
								currentPath === `/category/${category.id}` ? 'text-white' : 'text-white/60 hover:text-white'
							]}
						>
							{category.title}
						</a>
					</li>
				))}
			</ul>
		</div>
	</div>
</nav>

<script>
	const menuButton = document.getElementById('nav-menu-button') as HTMLButtonElement | null;
	const menuIcon = document.getElementById('nav-menu-icon') as SVGElement | null;
	const menu = document.getElementById('nav-menu') as HTMLDivElement | null;

	if (menuButton && menuIcon && menu) {
		const btn = menuButton;
		const icon = menuIcon;
		const menuEl = menu;
		let isOpen = false;

		function toggleMenu(): void {
			isOpen = !isOpen;
			
			if (isOpen) {
				// Open: set max-height to content height
				menuEl.style.maxHeight = menuEl.scrollHeight + 'px';
				icon.style.transform = 'rotate(180deg)';
			} else {
				// Close: set max-height to 0
				menuEl.style.maxHeight = '0';
				icon.style.transform = 'rotate(0deg)';
			}
			
			btn.setAttribute('aria-expanded', isOpen.toString());
		}

		btn.addEventListener('click', toggleMenu);

		// Close on Escape key
		document.addEventListener('keydown', (e) => {
			if (e.key === 'Escape' && isOpen) {
				toggleMenu();
			}
		});

		// Close menu on window resize to desktop
		window.addEventListener('resize', () => {
			if (window.innerWidth >= 768 && isOpen) {
				menuEl.style.maxHeight = '0';
				icon.style.transform = 'rotate(0deg)';
				btn.setAttribute('aria-expanded', 'false');
				isOpen = false;
			}
		});
	}
</script>
