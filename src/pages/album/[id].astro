---
import Layout from '../../layouts/Layout.astro';
import PhotoGrid from '../../components/PhotoGrid.astro';
import Lightbox from '../../components/Lightbox.astro';

// WHY [id].astro: Dynamic route for individual album pages
// WHY getStaticPaths: Pre-render all album pages at build time for optimal performance

export function getStaticPaths() {
  // Load all albums to generate static paths (inside function to avoid scope issues)
  const albumModules = Object.values(
    import.meta.glob('/src/content/albums/*.json', { eager: true })
  );

  // WHY map to params: Astro requires params object with dynamic route parameters
  return albumModules.map((module: any) => ({
    params: { id: module.default.id },
    props: { album: module.default },
  }));
}

// WHY destructure from Astro.props: Access album data passed from getStaticPaths
const { album } = Astro.props;

// Load category for this album to show back link
const categoryModules = Object.values(
  import.meta.glob('/src/content/categories/*.json', { eager: true })
) as any[];
const category = categoryModules.find(
  (module) => module.default.id === album.category
)?.default;
---

// WHY conditional render: Return 404 for non-existent albums (should not happen with getStaticPaths)
{!album ? (
  <Layout title="Album Not Found">
    <div class="container mx-auto px-4 py-8">
     	<div class="max-w-7xl">
				<h1 class="text-4xl font-bold mb-4">Album Not Found</h1>
				<p class="text-text-secondary">
					The requested album does not exist.
				</p>
			</div>
		</div>
  </Layout>
) : (
  <Layout title={`${album.title} - Portfolio`}>
    <div class="container mx-auto px-4 py-8">
			<div class="max-w-7xl">
				<header class="mb-6">
					<div class="flex items-center gap-4 mb-4">
						{
							category && (
								<a
									href={`/category/${category.id}`}
									class="text-sm text-accent hover:underline flex items-center gap-1"
								>
									<span>←</span>
									{category.title}
								</a>
							)
						}
					</div>

					<h1 class="text-4xl font-bold mb-2">{album.title}</h1>
					{album.description && (
						<p class="text-text-secondary mb-4">{album.description}</p>
					)}
					<p class="text-sm text-text-secondary">
						{new Date(album.date).toLocaleDateString('ru-RU', {
							year: 'numeric',
							month: 'long',
							day: 'numeric',
						})}
						{album.photos && (
							<span> · {album.photos.length} фото</span>
						)}
					</p>
				</header>

				{
					album.photos && album.photos.length > 0 ? (
						// WHY PhotoGrid component: Masonry layout with lazy loading and lightbox integration
						<>
							<PhotoGrid photos={album.photos} albumTitle={album.title} />
							<Lightbox photos={album.photos} />
						</>
					) : (
						<div class="text-center py-20">
							<p class="text-text-secondary">
								В этом альбоме пока нет фотографий.
							</p>
						</div>
					)
				}
			</div>
		</div>
  </Layout>
)}
